name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    
    runs-on: ${{ matrix.runner }}
    name: Build and Test (${{ matrix.arch }})

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y libelf-dev zlib1g-dev

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt

    - name: Build
      run: cargo build --verbose

    - name: Run tests
      run: cargo test --verbose

    - name: Check format
      run: cargo fmt -- --check

  build-test-format:
    needs: test
    runs-on: ubuntu-latest
    name: Build and Test Status
    steps:
      - name: Report success
        run: echo "All build and test jobs completed successfully"
